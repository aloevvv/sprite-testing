<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sprite Test</title>
<style>
    body { background: #111; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
    canvas { background: #222; border: 2px solid #555; }
</style>
</head>
<body>

<canvas id="spriteCanvas" width="800" height="800"></canvas>

<script>
const canvas = document.getElementById("spriteCanvas");
const ctx = canvas.getContext("2d");

const SPRITE_WIDTH = 400;
const SPRITE_HEIGHT = 400;
const FRAME_COUNT = 5;

const linearFrames = [0, 1, 2, 3, 4];
const TOTAL_ANIM_FRAMES = linearFrames.length;

const BPM = 170;
const TICKS_PER_BEAT = 10;
const TICK_RATE = (BPM / 60) * TICKS_PER_BEAT; 
const HOLD_TICKS = 4; 

let audioContext = null;
let audioBuffer = null;
let audioStartTime = 0;
let currentKey = null;

const sprite = new Image();
sprite.src = "bf-test.png";

const poses = {
    "ARROWUP": new Image(),
    "ARROWDOWN": new Image(),
    "ARROWLEFT": new Image(),
    "ARROWRIGHT": new Image()
};
poses.ARROWUP.src = "bf_up.png";
poses.ARROWDOWN.src = "bf_down.png";
poses.ARROWLEFT.src = "bf_left.png";
poses.ARROWRIGHT.src = "bf_right.png";

window.addEventListener("keydown", (e) => { currentKey = e.key.toUpperCase(); });
window.addEventListener("keyup", () => { currentKey = null; });

canvas.addEventListener("click", () => {
    if (audioContext) return;
    audioContext = new AudioContext();
    fetch("song.mp3")
        .then(r => r.arrayBuffer())
        .then(buf => audioContext.decodeAudioData(buf))
        .then(decoded => {
            audioBuffer = decoded;
            start();
        });
}, { once: true });

function start() {
    const src = audioContext.createBufferSource();
    src.buffer = audioBuffer;
    src.connect(audioContext.destination);
    audioStartTime = audioContext.currentTime;
    src.start();
    setInterval(drawFrame, 1); 
}

function drawFrame() {
    if (!audioContext) return;

    const t = audioContext.currentTime - audioStartTime;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (currentKey && poses[currentKey]) {
        ctx.drawImage(poses[currentKey], 0, 0, 800, 800);
    } else {
        const tick = Math.floor(t * TICK_RATE);
        const animFrame = Math.floor(tick / HOLD_TICKS) % TOTAL_ANIM_FRAMES;
        const spriteFrame = linearFrames[animFrame];

        ctx.drawImage(
            sprite,
            spriteFrame * SPRITE_WIDTH, 0,
            SPRITE_WIDTH, SPRITE_HEIGHT,
            0, 0,
            800, 800
        );
    }
}
</script>
</body>
</html>
