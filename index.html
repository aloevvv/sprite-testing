<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sprite Test</title>
<style>
    body {
        background: #111;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
    }
    canvas {
        background: #222;
        border: 2px solid #555;
    }
</style>
</head>
<body>

<canvas id="spriteCanvas" width="800" height="800"></canvas>

<script>


const canvas = document.getElementById("spriteCanvas");
const ctx = canvas.getContext("2d");

const SPRITE_WIDTH = 400;
const SPRITE_HEIGHT = 400;
const FRAME_COUNT = 5;

const pPFrames = [];
for (let i = 0; i < FRAME_COUNT; i++) pPFrames.push(i);
for (let i = FRAME_COUNT - 2; i > 0; i--) pPFrames.push(i);

const TOTAL_ANIM_FRAMES = pPFrames.length;

const BPM = 170;
const TICKS_PER_BEAT = 10;
const TICK_RATE = (BPM / 60) * TICKS_PER_BEAT; 
const HOLD_TICKS = 2; 

let audioContext = null;
let audioBuffer = null;
let audioStartTime = 0;

const sprite = new Image();
sprite.src = "bf-test.png";

canvas.addEventListener("click", () => {
    if (audioContext) return;

    audioContext = new AudioContext();

    fetch("song.mp3")
        .then(r => r.arrayBuffer())
        .then(buf => audioContext.decodeAudioData(buf))
        .then(decoded => {
            audioBuffer = decoded;
            start();
        })
        .catch(err => console.error("Audio load error:", err));
}, { once: true });

function start() {
    const src = audioContext.createBufferSource();
    src.buffer = audioBuffer;
    src.connect(audioContext.destination);
    audioStartTime = audioContext.currentTime;
    src.start();
    requestAnimationFrame(drawLoop);
}

function drawLoop() {
    drawFrame();
    requestAnimationFrame(drawLoop);
}

function drawFrame() {
    if (!audioContext) return;

    const t = audioContext.currentTime - audioStartTime;

    const tick = Math.floor(t * TICK_RATE);

    const animFrame = Math.floor(tick / HOLD_TICKS) % TOTAL_ANIM_FRAMES;
    const spriteFrame = pPFrames[animFrame];

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(
        sprite,
        spriteFrame * SPRITE_WIDTH, 0,
        SPRITE_WIDTH, SPRITE_HEIGHT,
        0, 0,
        SPRITE_WIDTH, SPRITE_HEIGHT
    );
}
</script>

</body>
</html>
