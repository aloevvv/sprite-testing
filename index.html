<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sprite Test</title>
<style>
    body { background: #111; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
    canvas { background: #222; border: 2px solid #555; }
</style>
</head>
<body>

<canvas id="spriteCanvas"></canvas>

<script>
const canvas = document.getElementById("spriteCanvas");
const ctx = canvas.getContext("2d");

const SPRITE_WIDTH = 500;
const SPRITE_HEIGHT = 500;
const FRAME_COUNT = 5;

const linearFrames = [0, 1, 2, 3, 4];
const TOTAL_ANIM_FRAMES = linearFrames.length;

const BPM = 170;
const TICKS_PER_BEAT = 10;
const TICK_RATE = (BPM / 60) * TICKS_PER_BEAT; 
const HOLD_TICKS = 4; 

let audioContext = null;
let audioBuffer = null;
let audioStartTime = 0;
let currentKey = null;

let poseUntil = 0;
let lastPoseFrame = null;
const MIN_HOLD = 0.12;

const sprite = new Image();
sprite.src = "bf-testing.png";

const keyFrames = {
    "ARROWLEFT": 5,
    "ARROWUP": 6,
    "ARROWRIGHT": 7,
    "ARROWDOWN": 8
};

window.addEventListener("keydown", (e) => {
    if (!audioContext) return;

    const key = e.key.toUpperCase();
    if (keyFrames[key] !== undefined) {
        currentKey = key;
        lastPoseFrame = keyFrames[key];
        poseUntil = audioContext.currentTime + MIN_HOLD;
    }
});

window.addEventListener("keyup", () => {
    currentKey = null;
});

canvas.addEventListener("click", () => {
    if (audioContext) return;
    audioContext = new AudioContext();
    fetch("song.mp3")
        .then(r => r.arrayBuffer())
        .then(buf => audioContext.decodeAudioData(buf))
        .then(decoded => {
            audioBuffer = decoded;
            start();
        });
}, { once: true });

function start() {
    const src = audioContext.createBufferSource();
    src.buffer = audioBuffer;
    src.connect(audioContext.destination);
    audioStartTime = audioContext.currentTime;
    src.start();
    setInterval(drawFrame, 1);
}

function drawSpriteFrame(frameIndex) {
    const cols = 4;
    const sx = (frameIndex % cols) * SPRITE_WIDTH;
    const sy = Math.floor(frameIndex / cols) * SPRITE_HEIGHT;

    ctx.drawImage(
        sprite,
        sx, sy,
        SPRITE_WIDTH, SPRITE_HEIGHT,
        0, 0,
        800, 800
    );
}

function drawFrame() {
    if (!audioContext) return;

    const nowAbs = audioContext.currentTime;
    const t = nowAbs - audioStartTime;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (currentKey && keyFrames[currentKey] !== undefined) {
        const frame = keyFrames[currentKey];
        lastPoseFrame = frame;
        poseUntil = nowAbs + MIN_HOLD;
        drawSpriteFrame(frame);
        return;
    }

    if (nowAbs < poseUntil && lastPoseFrame !== null) {
        drawSpriteFrame(lastPoseFrame);
        return;
    }
    const tick = Math.floor(t * TICK_RATE);
    const animFrame = Math.floor(tick / HOLD_TICKS) % TOTAL_ANIM_FRAMES;
    const spriteFrame = linearFrames[animFrame];

    drawSpriteFrame(spriteFrame);
}
</script>
</body>
</html>
